\documentclass[11pt]{article}

\usepackage[dvipdfmx]{graphicx}
\usepackage{fancyhdr}
\usepackage{here}
\usepackage{comment}
\usepackage{mathtools}
\usepackage{amsmath, amssymb}
\usepackage{type1cm}
\usepackage{multirow}
\usepackage{enumerate}
% 上下に2.5cm、左右に20cmの余白を取る
\usepackage[top=30mm, bottom=30mm, left=20mm, right=20mm]{geometry}
\usepackage{listings} %,jlisting日本語のコメントアウトをする場合jlisting（もしくはjvlisting）が必要
%ここをtrueにすると全ビルド
\newcommand{\ifdraft}{false}

%ここからソースコードの表示に関する設定
\lstset{
  basicstyle={\ttfamily},
  identifierstyle={\small},
  commentstyle={\smallitshape},
  keywordstyle={\small\bfseries},
  ndkeywordstyle={\small},
  stringstyle={\small\ttfamily},
  frame={tb},
  breaklines=true,
  columns=[l]{fullflexible},
  numbers=left,
  xrightmargin=0zw,
  xleftmargin=3zw,
  numberstyle={\scriptsize},
  stepnumber=1,
  numbersep=1zw,
  lineskip=-0.5ex
}


\newif\iffigure
%\figurefaulse
\figuretrue
%select show the figure or not

\makeatletter
\def\@cite#1{\textsuperscript{#1)}}
\def\@biblabel#1{#1)}
\makeatother

\newcommand{\DATE}[3]{#1年#2月#3日} %month, day, year
\newcommand{\TheDay}{\DATE{2020}{11}{17}}
\newcommand{\Header}{中須賀・船瀬研究室　輪講資料}

\title{卒業研究報告} %最終発表
\date{\TheDay}
\author{
B4　西本 慎吾%\thanks{shingo_n@space.t.u-tokyo.ac.jp}
}

%ヘッダの指定：
\pagestyle{fancy}

\begin{document}
\maketitle
\thispagestyle{fancy}
\lhead[\Header]{\Header} % ヘッダ左側
%\chead[偶数ページの引数]{奇数ページの引数} %ヘッダ中央
\rhead[\TheDay]{\TheDay} %ヘッダ右側
%\lfoot[偶数ページの引数]{奇数ページの引数} %フッタ左側
%\cfoot[偶数ページの引数]{奇数ページの引数} %フッタ中央
%\rfoot[偶数ページの引数]{奇数ページの引数} %フッタ右側


%あとでincludeからinputに戻すかな
\include{abtract.tex}

\include{introduction.tex}

\section{本研究での目的}
以上を踏まえると，
不具合発生時に故障候補を洗い出し，その中から
原因を特定していく過程に，高い知識と経験が必要である
ことが，衛星の不具合やリスクの分析が不十分に
なっている原因の一つであると推察される．
また，故障候補の網羅的な洗い出し
に関しては広く取り組まれている一方で，仮説の検証作業の支援に関して
取り組んだ研究は行われていない．

そこで本研究では，経験が浅く，衛星に関する知識の乏しいエンジニアであっても，
不具合事象から故障箇所の特定を行えるような不具合分析支援手法の提案を目的とする．
また，以下では不具合発生から故障箇所の特定を行う過程を「不具合分析」と表現している．\\
%具体的にどのような支援を目指すのか？
具体的には，本手法はコマンドとテレメトリをベースにして行う不具合分析を対象にしており，
不具合発生時に故障箇所を特定するために，確認すべきテレメトリ，打つべきコマンド
を選択肢として提示することで，人間の判断の支援を行う．\\
また，不具合原因特定の全ての過程を対象の制約モデルを用いて行うことは，
対象とするモデルの粒度に非常に高い忠実度が求められるため，複雑に物理現象が絡み合う
衛星では難しい．
むしろ，人間を対話的にサポートすることによってシステムに求められるモデル化のコスト
を下げつつ，不具合分析の過程を体系化することで，経験の少ないエンジニアの支援が
できると考えられる．
そのため，システムが提示した選択肢を用いて人間が実機での検証を行い，
その結果をシステムにフィードバックすることで，対話的に故障箇所の特定を行っていく
構成になっている．\\
%ここに手法の簡単な構成を入れたほうがいいのか？提案手法の中にまとめてしまうのか？
以上の機能を満たすために，本手法は下記の3つの要素で構成されている．
\begin{itemize}
   \item 衛星内部のコンポーネント間接続関係モデル及び，情報伝達経路モデル
   \item 故障箇所の特定を行うために必要なコマンド及びテレメトリの探索 %ここの言い回し
   \item 人間の判断を支援するコマンドの評価指標の提案
\end{itemize}

%以下で何を書くかをまとめる
%まずは手法の説明
%モデルの説明
%コマンドを評価するための指標に関して
%探索のアルゴリズムの具体的説明？？？
%実装結果（できればわかりやすい形で示したい）
%探索結果に関する考察

\section{提案手法}
%最終的に目標とするシステムの流れを示す
以下のFigure \ref{fig:fault_diagnosis}に，本手法を用いて不具合分析を行う流れを示す．
本研究の対象は，Figure \ref{fig:fault_diagnosis}で色付けしているところであり，
不具合発生時の異常テレメトリ情報が与えられてから，故障仮説の生成，
その仮説を検証するための「コマンド及び確認事項」を探索し，人間に提案を行うところまでである．

\subsection{不具合分析アルゴリズム}
%検証結果のフィードバックもできるようにする予定.
%ただし，OK　NGという簡単なフィードバック．パラメータ的な状態量は組み込めていない
\begin{figure}[H]
   \centering
      \includegraphics[height=9.0cm]{figure/fault_diagnosis_flow.png}
      \caption{不具合分析の流れ}
      \label{fig:fault_diagnosis}
\end{figure}

本手法を用いた不具合分析の流れは以下である．
\begin{enumerate}[1]
   \item 異常検知のきっかけとなったテレメトリ群を与える．
%   どこが異常値なのかを認識させる． 
   %不具合を起こしたトリガーが何なのかは分からないが，コマンドによってもたらされたかの区別だけ必要？
   \item そのテレメトリに影響を与えるコマンドを送信してから，
   地上局がテレメトリを受信するまでの一連の経路を取得する．
   \item 得られた経路内にあるコンポーネントを「故障候補」として登録する（故障仮説の生成）．
   %その経路に対してコマンドパスとして入力があれば，入力の元となっているコンポーネントも故障候補に追加する．
   %ココらへんの細かい流れは図に表現できていないので，あとで説明する形を取る
   %\item 他のテレメトリを確認することによって，棄却できる「故障候補」を棄却する．
   %\item コマンドを送って得られるテレメトリ情報によって，故障候補を確認することができるコマンドの探索を行う．
   \item 打つコマンドが無くなるか，不具合原因の特定ができるまで以下を繰り返す．
   \begin{enumerate}[\textrm{4.}1]
      \item 故障候補を確認するためのテレメトリ及びコマンド探索
      \item 上で得られたコマンド及び確認事項を，人間の判断を支援する指標と共に
      提示する．
      \item システムが提示した情報を元に人が打つコマンドを選択し，仮説の検証を行う．
      \item 送信コマンドに対するテレメトリを確認し正常かどうかのフィードバックを行う．
      \item 人間からのフィードバックに応じて故障仮説の棄却及び，モデルが持つ状態の更新を行う．
   \end{enumerate}
\end{enumerate}
故障候補を確認するためのテレメトリ・コマンド探索の流れの詳細に関しては
後ほど言及する．
%また，本手法では故障候補は異常テレメトリが通る経路内にあるコンポーネントとしており，
%網羅的に洗い出せているとは言えない．



%ここにモデルの説明
%これらのモデルに基づいて，実装上ではどのようなオブジェクトが生成され
%どのように関係しているのかを図示できたほうがいい
\subsection{事前定義モデル}
次に，以上で述べたアルゴリズムで不具合分析を行うために必要なモデル
に関して，具体的なテストケースをベースにして説明する．%言い回し

%これも既にモデル．先にどんなモデルが必要になるのかをまとめておいたほうがいいのか？
\subsubsection{対象とするテストケース}
今回，以下のFigure \ref{fig:simple_sat}の
ような簡易衛星モデルを対象にしてモデルの定義及び
不具合分析手法の実践を行う．\\
また，矢印の色が情報の方向性を表しており，赤がコマンドによる情報の伝達，
青がテレメトリによる情報の伝達である．また，矢印の種類が情報として伝わる物
を表しており，それぞれ以下のようになっている．
\begin{itemize}
   \item Signal：電気信号
   \item Power：電源
   \item Heat：熱
\end{itemize}
\begin{figure}[H]
   \centering
      \includegraphics[height=13.0cm]{figure/satellite_diagram.PNG}
      \caption{簡易衛星モデル}
      \label{fig:simple_sat}
\end{figure}

\subsubsection{各コンポーネント間の接続関係モデル}
來村ら\cite{Kitamura01}は拡張デバイスオントロジーとして，
機器を構成する装置間のつながりを表現するために「ポート」と「導管」%ここの説明を考える
という概念を定義している．このオントロジーを用いて，山口ら\cite{Yamaguchi2014}
は人工衛星デバイスオントロジーを構築している．
%論文ではもう少し詳細に説明する．
これらを参考にし，以下のTable \ref{tab:link_definition}のように
接続関係を「リンク」として定義した．\\%違いを説明する必要があると思う
リンクが持つ情報としては，リンク名，接続コンポーネント，ID，伝達物，
そのリンクが正常に情報伝達を行う確率%言葉がむずい
となっており，IDが各リンク固有の識別子としてリンクを参照する際に
使用される．また，実際にコンポーネント間を接続している実態（配線やコネクタなど）を表現している
のではなく，接続関係を概念的に表現したものにすぎない．
%そのメリットは何なん？
%ほんまはちゃんとポートと導管を作ったほうが良かったんかもしれん

%\newpage
%キャプションとくっついているか確認
%図新しいのに変える
\begin{table}[H]
   \centering
   \caption{リンク定義例}
   \label{tab:link_definition}
\end{table} 
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[height=11cm]{figure/link_definition.png}
\end{figure}

次に，コンポーネントの定義を行う．以下のTable \ref{tab:compo_link}では，
衛星システム全体で使用されている
コンポーネントのリストを作成し，各コンポーネントが接続している
コマンドリンクとテレメトリリンクを，上で定義したリンクのID
を用いて定義している．
ここで，コマンドリンクというのはコマンドによる情報の伝達で使用されるリンクであり，
テレメトリリンクというのはテレメトリによる情報の伝達で使用されるリンクである．
この時，コンポーネントが属性として持つリンクはそのコンポーネントが出力元となる場合としている．

%キャプションとくっついているか確認
%図新しいのに変える
\newpage
\begin{table}[H]
   \centering
   \caption{コンポーネント定義例}
   \label{tab:compo_link}
\end{table}
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[width=10cm]{figure/compo_link.png}
\end{figure}

以上の情報によって，衛星内部でコンポーネント全体がどのように接続しているか
を定義することが可能になる．\\
%なんか説明が微妙
また，各コンポーネントの状態を以下の
Figure \ref{fig:Compo_state}のように定義する．
本研究では，簡単のため扱う状態は，各コンポーネントの電源状態，
それに伴う電力消費，姿勢変化及び，熱の発生としている．
また，電源ON/OFF状態以外にも機能を持つコンポーネントは
その機能をFunctionで定義しており，機能の
動作状態がコマンドによって操作される構成となっている．
初期状態をFigure \ref{fig:Compo_state}のようなファイル形式で与え，
その後の状態の更新は人間が選択したコマンドが持つ機能情報に基づいて
行うようにしている．
%現状のモデルではON/OFF状態や機能動作の正否のような2値状態のみしか扱えていないが，
%将来的にはパラメータを含む状態量も扱えるように拡張していく予定である．
\begin{figure}[H]
   \centering
      \includegraphics[height=5.0cm]{figure/Component_state.png}
      \caption{コンポーネント初期状態例}
      \label{fig:Compo_state}
\end{figure}

\subsubsection{コマンド・テレメトリの情報がコンポーネント間を伝わる経路のモデル}
今回の衛星モデルにおけるテレメトリ及びコマンド
を以下のTable \ref{tab:telemetry}，\ref{tab:command}に定義した．\\
まず，本手法で用いるテレメトリの情報は，ID，テレメトリの名前，
テレメトリが変化するためのトリガー，テレメトリの情報が衛星内部及び地上局まで伝わる
経路である．
今回は簡単のため，状態が変化するためのトリガー(TransitionTrigger)として，
時間とコマンドのみを考えており，姿勢変化や軌道条件に依存した
状態変化は考えないことにする．また，経路は通るリンクのIDを用いて
表現している．

%経路はjsonで記述したほうが扱いやすいし，分かりやすい．時間あれば実装も含めて修正
%経路だけじゃなくて，遷移するトリガーも加えたことを記述
%テレメトリも種別必要なんじゃね？あと，降りているかどうかという状態も必要そう．
%ここに書くかは別として
\newpage
\begin{table}[H]
   \centering
   \caption{使用テレメトリ}
   \label{tab:telemetry}
\end{table}
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[width=14.0cm]{figure/TEL.png}
\end{figure}

また，コマンドの情報としてID，コマンドの名前，コマンドによって影響を受ける
テレメトリのID，コマンドの種別，コマンドによって情報が伝達する経路を与えている．
今回，Table \ref{tab:telemetry}に示すテレメトリの経路及び，Table \ref{tab:command}
に示す経路と影響テレメトリIDに関しては事前に定義したものを使用した．

また，コマンドが持つ機能によって，いくつかの種別に分類することができる．
JAXA\cite{JAXA2020}は，衛星と衛星搭載機器の機能をモデル化し，機能情報の
再利用性を高めることを目的とした手法を提案している．
今回，その手法の中の一部を採用しコマンドの種別を2種類(ACTION, GET)定義した．
また，各コマンドが持つ機能に関する情報を
以下のFigure \ref{fig:COM_type}のように定義している．
これによって，各コマンドが
上記で定義したコンポーネントが持つ機能を操作するという関係性を表現可能になる．
%この情報を用いて，不具合原因特定のためのコマンド
%を探索する際に有効となるコマンドを判断している．

\newpage
\begin{table}[H]
   \centering
   \caption{使用コマンド}
   \label{tab:command}
\end{table}
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[width=16.5cm]{figure/COM.png}
\end{figure}

\begin{figure}[H]
   \centering
      \includegraphics[height=5.0cm]{figure/COM_type.png}
      \caption{コマンドの機能モデル}
      \label{fig:COM_type}
\end{figure}


\subsection{コマンド評価指標}
次に，上記のアルゴリズムによって故障候補の切り分けを行う際，
人間がコマンドを選択するための指標に関して説明する．
%ここに軽く指標に関してどのような指標が必要なのか書いたほうがいいかも
不具合分析を行う際，衛星の安全を確保しながら正確な故障箇所の特定を行うことが，
地上での不具合改修に必要である．
そのため，コマンドが衛星にとって安全であることが重要である．\\
また，本研究の当初の目的は地上試験における不具合分析支援であったが，提案手法は
コマンドとテレメトリの粒度で得られる情報を用いて不具合分析を行っているため，
軌道上での運用時にも活用できると考えられる．
運用時には地上試験時とは異なり，不具合改修のための時間制約が発生することがあるため，
地上試験時とは異なる指標が必要となる．
そのため以下では，地上試験時と運用時の両方に関してコマンドを選択する上で必要な指標として
コマンドによる衛星生存性への副作用を示す指標とコマンドの故障候補の切り分け能力を示す指標
を提案し，
システムの使用状況に合わせてそれらの評価指標を切り替えることのできる
フレームワークであることを示す．

%ここ文章過ぎてしんどい．．．
\subsubsection{コマンドによる衛星生存性への副作用}
打つコマンドが安全であるかという点は，衛星の状態に依存するが，不具合発生時には
衛星の状態把握が十分に行えていない状況であるため，
網羅的にリスクを考慮した安全性を評価するのは困難である．
そこで，以下では簡単に電力と姿勢の制約を元に，コマンドの危険性を定量化する
ための指標を示す．\\
%BAT残量の定義がおかしいことに関して，どのような仮定をおいているのかを説明するべき
まず，運用時には発電量と各コンポーネントの電力消費状態に応じて
電力の制約が発生する．バッテリ残量が残り少ない状態で大きな電力を消費するコンポーネントの
電源をONにするといったことは，衛星の生存を脅かす危険な動作であると言える．
コマンドを選択する際に電力に関する制約を明示的に示すことは，未熟な運用者が誤ったコマンドを
打つことを防ぐために効果的であると考えられる．
そのため，コマンドの副作用を示す一つの指標として「バッテリ残量」と「コマンドを打つことに
よって発生する消費電力」を示すことにする．
%ここは別に説明せんくていい
ここでは簡単のため，バッテリ残量は電源がONになっている機器の消費電力のみから計算することとし，
姿勢の変化や日照条件に応じた充電量の変化は考慮していない．\\
次に，姿勢の制約による指標に関して述べる．
今回のモデルでは姿勢が変化することによる各状態量への影響は考慮していないが，
軌道上で姿勢が変化すると日照条件や入放熱量など，様々な波及効果が考えられ，
衛星の状態が大きく変化する．そのため本手法では姿勢変化を起こすことは，衛星の生存にとって
リスクの大きな動作であると考え，「姿勢変化を起こすか否か」を二つ目の指標として
提示する．

最後に，コマンドによる波及効果の大きさを示す指標に関して述べる．
上述したように，不具合発生時は状態に対する不確定性が大きいため，
状態を大きく変化させるようなコマンドは危険であると言える．
そこで，コマンドによって発生する衛星内部状態の変化の大きさを
%簡単にはテレメトリの数でいい気がするが．．とりあえず保留
%上記で定義したコンポーネントの状態（電源状態及び機能動作状態）
%が変化した数を用いることにする．
「コマンドを打つことで変化する
テレメトリの数」を用いて定量的に示す．これは，事前にコマンドの定義によって定められている
ため，コマンドを選択した時点で一意に決まる．この情報を示すことで，
コマンドが引き起こす衛星内部の状態変化の大きさを
人間に対して認識させることが可能である．\\
以上で述べたコマンドの副作用を示す3つの指標を以下に再掲する．
\begin{itemize}
   \item コマンドを打つ前のバッテリ残量と，コマンドを打つことによって発生する消費電力
   \item 姿勢変化を起こすか否か
   \item コマンドを打つことで変化するテレメトリの数
\end{itemize}

\subsubsection{コマンドの故障候補切り分け能力}
%運用中の時間制約を先に言ったほうが流れがわかりやすい．効果とそれに応じた要求の対応が取れるようにする
運用時には
可視時間が限られており，その可視パス中に不具合原因を特定しなければならないような時間制約
がある場合がある．その際には，少ないコマンド数で効率的に不具合分析が行えることが重要である．\\
%確実にというのは間違って故障候補を特定するとか，見るべき故障候補を見逃すとかがないようにということ
効率的な不具合分析を行うためには，一度に確認できる故障候補の数が多いことが望ましい．
コマンドによる検証を行う際，検証結果が正常テレメトリであれば，そのコマンドとテレメトリで形成される
経路内にある故障候補は正常であると言えるため，故障候補の切り分けを行うことができる．
一方で，選択したコマンドによる検証結果が異常テレメトリであった場合，
伝達する情報が経路内のどこで異常になったかが分からなければ，その経路内に
存在する故障候補の切り分けを行うことはできない．
そのため，経路内に多くの故障候補が存在する場合でも，
切り分けの能力が高いとは言えない．故障候補の切り分け能力を考えるためには，
検証結果が正常，異常に関係なく経路内にある
故障候補をどれだけ確認できるかが重要になる．
そのため以下では，故障候補にあるリンクが正常に情報を伝達できる確率を用いて，
コマンドが確認できるリンクの数を見積もる．

%あとここで言っている正常はつながりが切れていないかという点であることを説明する？
各コマンドによって情報が伝達し，テレメトリとして地上局に返ってくる経路によって，
確認する対象のリンクまでに通る経路が異なる．
その各経路に存在するコンポーネントをつなぐリンクが正常である確率を
$P(l = \text{normal})$，異常である確率を$P(l = \text{abnormal})$ %確率Pも斜体じゃないほうがええかも
として与える．
あるリンク$l_i$を確認するためには，リンク$l_i$が接続されているコンポーネントまでの経路
が正常であることが必要である．このことから，「リンク$l_i$を確認することができる確率」
がそれぞれの経路によって定まる．このことを以下のFigure \ref{fig:route}に示す例を用いて示す．
以下では簡単のため，$P(l_i = \text{normal}) = P(l_i = \text{abnormal}) = 0.5$であるとし，
太矢印になっている箇所が故障候補である．故障候補以外は正常であるとし，
$P(l_i = \text{normal}) =1$である．\\
\begin{figure}[H]
   \centering
      \begin{tabular}{c}
         \begin{minipage}{0.30\hsize}
         \centering
         \includegraphics[height=7cm]{figure/route1.png}
          %  \caption{}
            \label{fig:route1}
         \end{minipage}
         \begin{minipage}{0.30\hsize}
         \centering
         \includegraphics[height=7cm]{figure/route2.png}
         %\caption{}
            \label{fig:route2}
         \end{minipage}
         \begin{minipage}{0.30\hsize}
            \centering
            \includegraphics[height=7cm]{figure/route3.png}
            %\caption{}
               \label{fig:route2}
            \end{minipage}
      \end{tabular} 
      \caption{故障候補とそれを確認するための情報伝達経路の例}%ここも変えたほうがいいかも
      \label{fig:route}
\end{figure}
Figure \ref{fig:route}では，あるコマンドC$_1$によって影響を受けるテレメトリ
が3つ存在する場合を示している．
各テレメトリとコマンドC$_1$が形成する経路は異なり，それぞれ経路1，2，3としている．\\
この時，それぞれの経路に関して
リンク1を確認することができる確率を考えることにする．まず，経路1でリンク1の確認をするためには
ノードBからノードDまでの経路(2,3,5,7)
が正常である必要がある．%正常の定義を明確に
ここで，経路を表す記号をR，経路内にある故障候補リンクの集合を$\mathbb{F}$とすると，
経路1を通る情報でリンク$1$を確認することができる確率は
\begin{eqnarray}
   P(l_{1} | \text{R}_1) &=& \prod_{i\in\mathbb{F}_1,i\neq 1} P(l_{i} = \text{normal})\\
     &=& \left( \frac{1}{2}\right)^4
\end{eqnarray}
であることが分かる．ここで，R$_1$は経路1，また
\begin{eqnarray}
   \mathbb{F}_1  &=& \{ 2,3,5,7\} 
\end{eqnarray}
である．\\
同様に経路2，3に関してもリンク$1$を確認することができる確率を求めると
\begin{eqnarray}
   P(l_{1} | \text{R}_2)  &=& \prod_{i\in\mathbb{F}_2,i\neq 1} P(l_{i} = \text{normal})\\
   &=& \frac{1}{2}\\
   P(l_{1} | \text{R}_3)  &=& \prod_{i\in\mathbb{F}_3,i\neq 1} P(l_{i} = \text{normal})\\
   &=& 1
\end{eqnarray}
となる．
このように，あるリンク$l_i$を通る経路が複数存在する場合，
経路に依存してそのリンク$l_i$を確認できる確率（以下では確認可能性とする）が変わる．
%なんで最大値を取るようにするのかの説明が必要になるかもしれない
ここで，あるコマンドC$_k$による情報伝達経路の中で，リンク$l_i$を通る経路
が複数存在する場合には，その経路のリンク$l_i$の確認可能性はそれらの最大値を取るものとする．
コマンドC$_k$が影響を与える各テレメトリと成す経路の内，リンク$l_i$を含むものを
$\mathbb{R}_{ki} = \{ \text{R}_{1_i}, \cdots ,\text{R}_{N_{ki}} \}$（ただし$N_{ki}$は
リンク$l_i$を含む経路の数）とすると，
コマンドC$_k$によるリンク$l_i$の確認可能性は
\begin{eqnarray}
   P(l_i|\text{C}_k) &=& \max  \{ P(l_i|\text{R}_{1_i}), \cdots ,P(l_i|\text{R}_{N_{ki}}) \}
\end{eqnarray}
となる．\\
これは経路$\mathbb{R}_{ki}$内にある故障可能性リンク全てに対して求めることができるので，
これらの平均を取り，そのコマンドの「平均確認可能性」と定義する．
平均確認可能性は，コマンドC$_k$が影響を与える各テレメトリと成す経路を
$\mathbb{R}_{k} = \{ \text{R}_{1}, \cdots ,\text{R}_{N_{k}} \}$とし，
それらに含まれる故障可能性リンクの数を$N_{F_k}$とすると
\begin{eqnarray}
   P_m(\text{C}_k) &=& \frac{1}{N_{F_k}}\sum_{i=1}^{N_{F_k}}P(l_i|\text{C}_k)
\end{eqnarray} %記号何がええんやろ
とできる．これは，コマンドとテレメトリが通る経路に含まれる
故障候補の内，どれだけのリンクの状態を確認できるかという指標である．
つまり，この指標が高いほど経路内に存在する故障可能性リンクの多くを
確認できるということになる．%これいらんかも
%それ以下でもそれ以上でもないのか？？

また，平均確認可能性を経路$\mathbb{R}_{ki}$内にある故障可能性リンクの数$N_{F_k}$
にかけると，コマンドC$_k$によって確認できるリンク数の期待値を求めることができ，
\begin{eqnarray}
   E(\text{C}_k) &=& N_{F_k}P_m(\text{C}_k)\\
   &=& \sum_{i=1}^{N_{F_k}}P(l_i|\text{C}_k)
\end{eqnarray} 
となる．これを「確認可能リンク数」と定義する．

ここで，Figure \ref{fig:route}に示すコマンド1に関して平均確認可能性及び，
確認可能リンク数を計算してみると
\begin{eqnarray}
   P_m(\text{C}_1) &=& \frac{1}{N_{F_1}} \{P(l_{1} | \text{C}_1) + P(l_{2} | \text{C}_1) +P(l_{3} | \text{C}_1)
   +P(l_{5} | \text{C}_1) + P(l_{7} | \text{C}_1)\} \\
   &=& \frac{1}{5} \{ 1 + \frac{1}{2} + \left( \frac{1}{2}\right)^4 + \left( \frac{1}{2}\right)^4
    + \left( \frac{1}{2}\right)^4 \}\\
    &=& 0.3375 \\
   E(\text{C}_1)  &=& 1.6875
\end{eqnarray} 
となる．
結果からわかるように，通る経路に存在する故障候補の数
が必ずしも確認できるリンクの数に対応しているわけではない．
故障候補にあるリンクを通ることで不確定性が蓄積されるため，全体として経路内にある
リンクを確認できる確率は小さくなる．
平均確認可能性が高く，確認可能リンク数も高いものが
故障候補の切り分け能力が高いコマンドであると言える．

\begin{comment}
   
このことを踏まえて，あるコマンドとテレメトリのペアによって形成される経路(R)を通る情報によって
故障候補の確認を行う際，経路内に含まれる故障候補の数（$N_F$とする）と
確認できるリンクの数の期待値($E$(R))の割合が，その経路を作るコマンドとテレメトリのペアが，
経路内の故障候補の内どれだけ確認することができるかを示している．\\
故障可能性リンクが多く含まれた，不確定性の大きな経路を通ると，

上で述べたように，切り分けを行っていくためには確実性が重要である．%???
そのため，その経路の「正の効果」を示す指標の一つとして確実性($C$(R)とする)を以下のように定義する．
\begin{eqnarray}
   C(\text{R})  &=& \frac{E(\text{R})}{N_F}
\end{eqnarray}
%ここらへん実装まで終わらして，ちゃんと有効であることを示せないと伝わらなさそう．
%有効でなければやり直しやが．．

以上では，コマンドとそれによって影響を受けるテレメトリとのペアによって形成される経路に対して
「正の効果」を定義していたが，各コマンドが影響を与えるテレメトリは複数存在することが多くある．
人間が選択する際にはコマンドに対して指標が必要である．\\
あるコマンドに関連する経路が複数ある場合，それらに関する「確認可能リンク数」及び「確実性」
の単純和を取るだけでは対象としているリンクに被りが生じるため，コマンドの効果を表している
とは言えない．
そこで，各経路で被りが生じているリンクに関しては，
そのリンクを通る経路の中で距離が最短な経路が確認を行うものとし上の指標を再定義を行う．
あるコマンド（C$_k$とする）が影響を与える各テレメトリと成す経路の集合を
$\mathbb{R}_k = \{ \text{R}_{1}, \cdots ,\text{R}_{N_k} \}$（ただし$N_k$はコマンドC$_k$
によって形成される経路の数）とする．
%これは実装で必要になるかも
%また$\mathbb{R}_k$は経路長さの昇順でソートされている
また，各経路(R)$_{i}$に含まれる故障候補
の集合$\mathbb{F}_{i}$の直和を取り%少し間違っているから修正
$\mathbb{R}_k$に含まれる故障候補の集合を，
%なんかいい方法思いつかんから保留
\begin{eqnarray}
    \mathbf{F_k} &=& \sum_{i=1}^{N_k} \mathbb{F}_i
%    \bigcup_{i=1}^N \left( \bigcup_{i=1}^N \mathbb{F}_i - \bigcap_{i=1}^N\right) 
\end{eqnarray}
とし，$\mathbf{F_k}$に含まれるリンクの数を$\mathbf{N_{F_k}}$とする．
この時，C$_k$の「確認可能リンク数」及び「確実性」は以下のようになる．
\begin{eqnarray}
   E(\text{C}_k)  &=&\sum_{i\in \mathbf{F_k}} \prod_{j\in \mathbf{F_k}, j\neq i} P(l_i=\text{normal})  \\
   C(\text{C}_k)  &=& \frac{E(\text{C}_k)}{\mathbf{N_{F_k}}}
\end{eqnarray}
\end{comment}

%ここに情報量を組み込むといいかも？めんどくさい

%ここ洗練させる
\subsubsection{評価指標の使い分け}
次に，地上試験と軌道上での運用とで上述した指標の使い分けに関して
説明する．
\begin{comment}
   
%エントロピー使うなら平均は取らない．
まず，コマンドを打つことによってどれだけの情報が得られるかという点から，
そのコマンドを打つことによる情報量を考えた．

その指標として，コマンドの能力を情報量（エントロピー）の定義から考えた．
無理にエントロピーを使うのは間違っている気がする．情報量という考え方が妥当ではないか？
確率分布になっていないことを考えると．

コマンド$j$による切り分けの効果の指標を以下に定義する．\\
コマンド$j$が確認できるリンクの集合を$\mathbb{L}_j$とする．
この時，集合に含まれるリンクは$l_i\in \mathbb{L}_j$とする．
また，
「$\mathbb{L}_j$を確認する」という事象を$\Omega$とすると，
各リンク$l_i$を確認するという事象$E_i \in \Omega$として，

ここで，各リンクの状態を確認する方法として，本手法ではコマンドによるアクセスのみを考えているので
「リンク$l_i$を確認する」という事象と，「リンク$l_i$を確認できるコマンドを選択する」
という事象の確率は等価である．%各コマンドを選ぶ確率は等しいという仮定が入っているような気がする．
よって，「リンク$l_i$を確認する」という事象の確率は式(\ref{eq:Pi})
で与えられる．この時，事象($E_i$)が起こった時に受け取る（選択）情報量$I_i$は式(\ref{eq:I_i})
で定義される．

\begin{eqnarray}
   P(E_i) &=& \frac{\text{Number of command which can verify Link }i}{\text{All command number}} \label{eq:Pi}\\
   I(E_i) &=& -\log{P_{i}} \label{eq:I_i} \\
\end{eqnarray}
確率$P(E_i)$は確率分布であるという説明が必要

よって事象$\Omega$による平均情報量は
\begin{eqnarray}
   H(P) &=& -\sum_{E_i \in \Omega} P(E_i)\log{P(E_i)} 
\end{eqnarray}
となる．定性的な意味としては，コマンドを打つことによってどれだけの情報
が得られる可能性があるかを示している．

コマンドが絞り込むことのできる能力という点はどうする？

以上の指標を踏まえた上でどのように提示し人間の判断を支援するのかを考える．
\end{comment}

%地上試験と運用時の両方で使い分けることのできるフレームワークであることを示す．
地上試験では，電源供給に関してはバッテリではなく安定化電源を用いた試験コンフィギュレーションで
行うことが多い．そのため，上述した電力の制約に関しては地上試験で考慮する必要はない．
また，試験時は衛星を試験台に固定して行うため，姿勢変化に関する制約も考慮する必要は
ないと考えられる．
これらを踏まえると，地上試験で安全を重視して二次故障などを引き起こさないように
切り分けを行うためには，波及効果の大きさを示す指標である
「コマンドによって影響を受けるテレメトリの数」が小さなコマンドを選択すれば良い．\\
また，地上試験では部分的なコンポーネントを組み上げた状態による試験も行う．
システムを構成するコンポーネントの種類によっては，コマンドの効果によって
二次故障が発生する可能性はあまりない場合も考えられる．
そのような際には，「平均確認可能性」及び「確認可能リンク数」
が大きなコマンドを選択することで効率的な切り分けが行える．

%地上試験での具体例を挙げて，指標の中で何を重視すればいいのかという説明をする
%確実性の必要性がよくわからないという指摘．これが高いと，コマンドが持つ能力の
%分を確認できる．つまり不確定な領域をなるべく通らすに故障候補を確認できるということ

一方で，運用中は先ほど述べた電力や姿勢に関する制約を考える必要がある．また，
可視時間中に不具合原因の特定を行わなければならないなどの
時間制約の厳しい条件下での分析が必要になることもある．
そのような時には，リスクを大きく取りつつ効果の大きなコマンドを選択する必要がある．
よって，運用時は上で示した全ての指標を考慮してコマンドの選択を行うことが望ましい．

%実践した結果を分かりやすく表示させるように変更して，その結果を例に説明するのがいいかもしれない
\subsection{故障候補を切り分けるためのコマンド及び確認事項の探索}
4.1で述べた不具合分析アルゴリズムにおける，
故障候補の中から切り分けを行うためのコマンド及び
確認事項の探索に関して，本手法における仮定とともに詳しく説明する．\\
不具合が発生している状態で予期せぬ二次故障を起こさないために，
探索順序としては，衛星の状態を変えずに確認できるものを優先的に探索
することが望ましい．
%ここ表現がわかりにくい
そのため，不具合発生時に取得しているテレメトリの中から
不具合原因特定に役に立つテレメトリ情報が存在するのであれば，
そのテレメトリを確認事項として提案する．\\
その後，衛星の状態を変化させること無く
故障原因特定のために得られる情報がなくなれば，
次ステップとしてコマンドを打って得られる
情報から切り分けを行っていくことになる．
このとき，残ったコマンドで故障候補の状態を確認できるものを探索し，
上で示した指標の計算を行い提示する．
%提示するコマンド候補としては，使用するコンテキストに適した評価指標に基づいて
%上位　のコマンドを指標の値とともに提示する．
%ここにフローチャート的なものあるといいよね

%ここはいらんかもな
本手法では簡単のため，コマンド及びテレメトリが情報を伝達する経路において，
故障候補を通るものがあれば「確認できる可能性がある」としている．
一方で，各コンポーネントの状態を一切変えないコマンドや，コマンドを送っても
テレメトリに変化として現れない組み合わせは，不具合原因特定のために得られる情報がないため
「確認できる可能性がない」としている．\\
ここであくまでも「確認できる可能性」として記述しているのは，コマンドの効果
についての説明で言及したように，通る経路に故障候補があったとしても，途中の経路で情報が途切れて
しまえば確認することはできないからである．

%ここは実践例
\section{実践例}
最後に，不具合分析の具体的な流れをみるために，以下のような故障を考え，
不具合分析を行っていく．\\
\begin{figure}[H]
   \centering
      \includegraphics[height=13.0cm]{figure/fault_mode1.png}
      \caption{故障モード(HTR\_Cam−Camera間)}
      \label{fig:fault_mode1}
\end{figure}
Figure \ref{fig:fault_mode1}に示すような，カメラヒータ−カメラ間
接触不良が発生している場合を考える．
この時，異常検知の際の不具合事象としては，
\begin{itemize}
   \item カメラヒータONコマンド(ID:15)を送信したのに，カメラ温度(ID:18)が上昇しない
\end{itemize}
という事象である．
以下に，この事象に本手法を適用した例を示す．
まず，Figure \ref{fig:tel_phase}に
故障候補の決定及び，テレメトリ情報を用いた確認の段階を示す．
故障候補の決定では，不具合事象を検知するきっかけとなったコマンドとテレメトリが形成する
経路を探索し，targetTEL，targetCOMとして提示している．\\
その後，時間変化するテレメトリ情報を用いて確認できる故障候補を提示し，
返ってくるテレメトリが正常かどうかを入力させることで，切り分けを行っている．

\begin{figure}[H]
   \centering
      \includegraphics[height=5.0cm]{figure/Tel_phase.png}
      \caption{テレメトリによる確認}
      \label{fig:tel_phase}
\end{figure}
次に，Figure \ref{fig:ini_COM_phase}に示すのが，不具合発生時に送信していたコマンド情報から
考えられるテレメトリの変化を用いて故障候補の確認を行う段階である．
今回は，初期コマンドとしては異常検知の際に送ったコマンド(カメラヒータON)のみ
を考えている．
%もう少し説明が必要そう
\begin{figure}[H]
   \centering
      \includegraphics[height=7.0cm]{figure/initial_COM_phase.png}
      \caption{初期コマンドを用いた確認}
      \label{fig:ini_COM_phase}
\end{figure}
以下のFigure \ref{fig:COM_candidate}に示すのが，上記の流れを経て残った
故障候補を確認できるコマンドを探索し，指標と共に提示した結果である．

\begin{figure}[H]
   \centering
      \includegraphics[width=12.0cm]{figure/COM_candidate.png}
      \caption{コマンドの選択肢表示}
      \label{fig:COM_candidate}
\end{figure}
\begin{figure}[H]
   \centering
      \includegraphics[height=8.0cm]{figure/COM_phase.png}
      \caption{コマンドによる確認}
      \label{fig:COM_phase}
\end{figure}

今回用意したコマンドとテレメトリだけでは，最終的な故障箇所の特定まで行うことができなかった．
設計段階においてFMEA上に定義されている故障モードに対して適用することで，実際の
試験時にその故障を特定するために必要なコマンドとテレメトリが定義されているかの確認作業にも
本手法は利用できると考えられる．

\begin{comment}
まず，MOBCとTOBCからテレメトリは全て降ろされているものと仮定する．
また，故障は「推進系ヒータの接着不良」であるとする．
その時，テレメトリを通して確認できるのは
\begin{itemize}
   \item 「推進系ヒータON」コマンドを送ったのに，「推進系温度」テレメトリが変化しない．
\end{itemize}
という事象である．
よって不具合検知は，この事象によって行われる．

\subsection{不具合分析の例}
この不具合において，「推進系ヒータON」コマンドを送信して推進系ヒータに熱が伝わるまでの経路
と，推進系温度計が温度を読み取り「推進系温度」テレメトリとして地上局に伝わるまでの
経路の中に故障箇所があると考えることができる．
この経路を以下のFigure \ref{fig:simple_sat_fault}に太矢印で示している．
%これにリンクID入れたら見やすいかも
\begin{figure}[H]
   \centering
      \includegraphics[height=9.0cm]{figure/simple_sat_fault.png}
      \caption{故障箇所と不具合検知に関連するコマンドとテレメトリの経路}
      \label{fig:simple_sat_fault}
\end{figure}
また，この経路内にあるコンポーネントに電源が入っているかどうかを確認するためには，
そのコンポーネントに電源を供給するための経路が正常に作動しているかどうかを確認する
必要がある．そこで
\begin{itemize}
   \item PCU$\rightarrow$MOBC(リンクID:4.2)，PCU$\rightarrow$TOBC(リンクID:5)
\end{itemize}
も検証を行う対象として考える．
以上より，検証すべき経路は下記のようになる．
\begin{itemize}
   \item コンポーネント：GS，MOBC，TOBC，Heater\_p，Prop，TempSensor\_p
   \item コマンドリンク：GS-MOBC(1)，MOBC-TOBC(3)，MOBC-PCU(4.2)，
   PCU-TOBC(5)，\\TOBC-Heater\_p(6)，Heater\_p-Prop(10)
   \item テレメトリリンク：GS-MOBC(1)，MOBC-TOBC(3)，TOBC-TempSensor\_p(8)，
   TempSensor\_p-Prop(14)
\end{itemize}
以下，提案手法によるアルゴリズムによって不具合分析を行っていく．\\
%この章長くて読みにくい
まず，問題設定よりMOBC及びTOBCのテレメトリは全てダウンリンクされている状態に
あるので，
\begin{itemize}
   \item テレメトリリンク:TOBC$\rightarrow$MOBC(3)，MOBC$\rightarrow$GS(1)
   \item コマンドリンク：PCU$\rightarrow$MOBC(4.2)，PCU$\rightarrow$TOBC(5)
\end{itemize}
は問題ないことが確認できるため，故障可能性はなくなる．
問題設定ではあるが，実際に「MOBC及びTOBCのテレメトリが全てダウンリンクされている」
ことを確認するためには，「MOBCカウンター」
「TOBCカウンター」を確認することが必要である．\\
また不具合発生時，推進系ヒータが正常に作動しており，
システム温度計からテレメトリを下ろす経路に問題がなければ，
「システム温度」が上昇しているはずである．
よって，テレメトリの確認によって検証できる経路として，
コマンドリンク「TOBC-Heater\_p(6)」がある．
以上より，不具合発生時から状態変化させずに確認すべき事項として以下
が挙げられる．

\begin{table}[H]
   \centering
   \caption{コマンドなしでの確認事項} 
   \label{tab:check_list1}
\end{table}
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[height=2.5cm]{figure/check_list_tel.png}
\end{figure}
衛星の状態を変化させること無く，テレメトリを確認するだけで
検証できる箇所はこれ以上存在しないので，次にコマンドによる検証を行う．

まず，コマンドパスとしてGSに近い箇所から順に確認を行う必要がある．
MOBCへのコマンドが通っているかを確認するためには，「MOBCコマンドカウンターアップ」
コマンドを送って，「MOBCコマンドカウンター」が変化していることを確認できれば良い．
同様に考えると，以下の様に確認事項を洗い出すことができる．
\begin{table}[H]
   \centering
   \caption{コマンド送信による確認事項} 
   \label{tab:check_list2}
\end{table}
\vspace{-2zh}
\begin{figure}[H]
   \centering
      \includegraphics[height=2.6cm]{figure/check_list.png}
\end{figure}
以上の項目を確認した際，今回想定した故障モード（推進系ヒータの接着不良）
では期待されるテレメトリデータの変化が起こるので，
Table \ref{tab:check_list2}の確認対象パスの中にある故障可能性箇所は
棄却され，
故障可能性リンクとして残るのは
\begin{itemize}
   \item コマンドリンク：Heater\_p-Prop(10)
\end{itemize}
となる．

%上のコマンドを送っても大丈夫なのかという議論はどうするのか？もしシステム温度が高いのに，その方法でたしかめてもいいものなのか？

この経路上で考えうる故障モードと照らし合わせると，
この切り分けによって残る故障モードは
\begin{itemize}
   \item 推進系ヒータの故障
   \item 推進系ヒータの接着不良
\end{itemize}
となる．
この時，
「システム温度」の上昇によって「推進系ヒータの故障」の可能性は
棄却できるため，最終的に「推進系ヒータの接着不良」
が残り，
実際の故障を棄却すること無く，絞り込みができていると言える．\\
\end{comment}

%今後の方針とかいるんかよ．どのように卒論にまとめていきたいか
%以上の不具合分析の流れを参考にし，探索のアルゴリズムを考えたい．
\section{今後の方針}
%専門家ばかりが関わっているわけではない，学生主導であるからという点も加える？
以上では，超小型衛星の信頼性向上の為の
不具合分析支援の手法に関して示し，テストケースに対する実践例を示した．
今後，いくつかの故障例を考えて実践し，
本手法を用いて不具合分析を行った結果と，指標を提示せず任意で
コマンドを選択した結果を比較し，
本手法の有効性を検証したいと考えている．
比較する際の評価軸としては
\begin{itemize}
   \item 効率的に不具合の切り分けが行えたかどうか（打ったコマンドの数で評価）
   \item 安全に切り分けを行うことができたかどうか（電力，姿勢の変化によって評価）
\end{itemize}
を考えている．
%評価軸を示して，この手法の有効性をどのように示す予定かをのべる．

\begin{comment}
\section{まとめ}

%これも今後の展望かな？？
モデル化に関して
実際の衛星ではコンポーネント数やコマンド・テレメトリの数
が膨大であるためモデルが複雑化し，人によるモデル生成では
ヒューマンエラーや，作業量を考えると非現実的である．
そのため，将来的にはこれらを必要最低限の情報から生成する手法に関しても
検討していく．

%これも今後の展望かな
また，故障診断のコンテキストによってどこまで掘り下げるべきか使い分けるべきである
\cite{Ontology1998}ことを書く．

%モデルの波及効果に関してこれは今後の展望で述べるとこかな
一方で，人工衛星は内部のコンポーネントが非常に密集しているおり，人間が設計時に考慮した
意図したつながりだけでなく，意図しないつながりも多く存在する．
このような意図しないつながりによって，波及効果が発生することが衛星内部の理解が
困難になり
\end{comment}

\bibliographystyle{junsrt} %plain, acm, alpha とか
\bibliography{Ref} 
\end{document}